# Migration audit (Rust port vs original C)

## Короткий вывод

- Миграция **не завершена**: Rust-порт сейчас не собирается (`cargo build` падает на множестве ошибок компиляции).
- Оригинальная C-реализация собирается после восстановления ожидаемых имен файлов (в репозитории они сохранены с префиксом `_`).
- Покрытие тестами по Rust-порту на текущий момент фактически отсутствует (`#[test]` не найдено).
- Добавлены скрипты для воспроизводимого аудита и e2e-smoke сравнения (как только Rust снова начнет собираться).

## Что добавлено в репозиторий

1. `scripts/e2e_compare.sh`
   - Строит оригинал в временной директории.
   - Восстанавливает классические имена `*.c/*.h` из `_*.c/_*.h`, чтобы upstream `Makefile` работал без ручных шагов.
   - Пытается собрать Rust-порт.
   - Если обе сборки успешны — запускает сравнительные smoke-кейсы:
     - `--version`
     - `--help`
     - невалидный флаг

2. `scripts/migration_audit.sh`
   - Показывает быстрые метрики миграции (число C/Rust модулей, стобы, тесты).
   - Запускает `scripts/e2e_compare.sh` и валится, если e2e-сравнение не прошло.

## Наблюдения по коду

- В исходниках Rust есть явные пометки про незавершенный перенос (stubs / not ported).
- Критическая блокировка — компиляция порта:
  - несовместимости libc-типов и констант,
  - packed/alignment проблемы в SOCKS5 структурах,
  - borrow-check ошибки в сетевой логике,
  - мелкие типовые несоответствия (`i16`/`i32`),
  - и др.

## Что делать дальше (приоритет)

1. Восстановить собираемость Rust (`cargo build` должен быть зеленым).
2. После этого включить `scripts/e2e_compare.sh` в CI как обязательный smoke-gate.
3. Добавить полноценные e2e тест-кейсы:
   - SOCKS5 CONNECT (IPv4/IPv6/domain),
   - UDP ASSOC,
   - сценарии desync-опций,
   - негативные кейсы и parity по кодам выхода/логам.
4. Добавить unit-тесты на парсеры и форматтеры (CLI, `parse_cform`, фильтры, rules).
